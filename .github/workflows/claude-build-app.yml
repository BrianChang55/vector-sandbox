name: Claude Build App

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Instruction to Claude Code (what to build/fix)"
        required: true
        type: string
      ref:
        description: "Branch or SHA to run against"
        required: false
        default: "main"
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  claude:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      # Optional but strongly recommended hardening
      # (see Step Security guidance for harden-runner style controls)
      # - name: Harden runner
      #   uses: step-security/harden-runner@v2
      #   with:
      #     egress-policy: audit

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          prompt: ${{ inputs.prompt }}
          # Pass CLI args
          claude_args: "--max-turns 20 --max-budget-usd 5 --dangerously-skip-permissions"
          # API key for Anthropic
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Use GitHub token to bypass OIDC/App authentication
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create branch, commit, and open PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create a unique branch name
          BRANCH_NAME="claude/build-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # Stage and commit all changes
          git add -A
          git commit -m "feat: Claude Code changes

          Prompt: ${{ inputs.prompt }}"
          
          # Push the branch
          git push origin "$BRANCH_NAME"
          
          # Create PR using GitHub CLI
          gh pr create \
            --title "Claude: ${{ inputs.prompt }}" \
            --body "This PR was automatically created by Claude Code Action.

          **Prompt:** ${{ inputs.prompt }}
          
          **Base branch:** ${{ inputs.ref }}" \
            --base "${{ inputs.ref }}"

      - name: Build & test (your project commands)
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # customize per stack
          if [ -f apps/web/package.json ]; then
            cd apps/web
            npm ci
            npm test --if-present
            npm run build --if-present
          fi
