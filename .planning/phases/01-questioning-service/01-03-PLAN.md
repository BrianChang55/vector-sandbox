---
phase: 01-questioning-service
plan: 03
type: execute
---

<objective>
Revise QuestioningService to be a pure distillation layer — no decisions, no inferences.

Purpose: Enforce the architectural principle that subservices distill, the main agent decides. The questioning service extracts and organizes facts from user responses; it does NOT decide sufficiency or infer requirements.

Output: Revised questioning_service.py and questioning.py prompts that extract only: goals, explicit requirements, UI mentions, and unknowns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-questioning-service/01-CONTEXT.md

**Key files to modify:**
@vector_app/prompts/questioning.py
@vector_app/services/questioning_service.py

**Architectural principle from CONTEXT.md:**
- QuestioningService is a pure distillation layer
- It extracts what user said, does NOT decide anything
- Output: goals, explicit requirements, UI mentions, unknowns
- Main agent receives this and decides sufficiency/next steps

**What must change:**
1. Remove sufficiency check entirely (or change to skip-detection only)
2. Update synthesis prompts to extract facts only, no inference
3. Update question generation to not decide when to stop
4. Update return types to match new output format
</context>

<tasks>

<task type="auto">
  <name>Task 1: Revise prompts to be extraction-only</name>
  <files>vector_app/prompts/questioning.py</files>
  <action>
Update the prompts module to enforce distillation-only behavior:

**1. Remove SUFFICIENCY_CHECK_* prompts entirely**
- Delete SUFFICIENCY_CHECK_SYSTEM_PROMPT
- Delete SUFFICIENCY_CHECK_PROMPT
- Delete build_sufficiency_check_prompt function

**2. Update QUESTION_GENERATION_SYSTEM_PROMPT:**
- Remove "Stop asking questions when..." guidance (service doesn't decide)
- Keep the question quality guidance
- Add: "Always generate a question. The main agent decides when to stop."

**3. Update QUESTION_GENERATION_PROMPT:**
- Remove "If you feel you have enough information, say 'I have enough...'"
- Simply ask for the next question, no conditional stop

**4. Replace SYNTHESIS_* prompts with EXTRACTION_* prompts:**

New EXTRACTION_SYSTEM_PROMPT should instruct:
- Extract ONLY what the user explicitly said
- NO inferences, NO "reasonable defaults", NO gap-filling
- Output structure: goals, explicit_requirements, ui_mentions, unknowns
- unknowns = things not answered OR answers that were unclear/vague

New EXTRACTION_PROMPT should format output as:
```json
{
  "goals": ["explicitly stated goal 1", "explicitly stated goal 2"],
  "explicit_requirements": ["user said they want X", "user mentioned Y"],
  "ui_mentions": ["user said dark mode", "user wants sidebar"],
  "unknowns": ["data source not specified", "unclear if real-time needed"]
}
```

**5. Rename builder function:**
- build_synthesis_prompt → build_extraction_prompt

**Keep unchanged:**
- Question generation prompt structure (just remove the decision part)
  </action>
  <verify>python -c "from vector_app.prompts.questioning import EXTRACTION_SYSTEM_PROMPT, build_extraction_prompt, QUESTION_GENERATION_SYSTEM_PROMPT; print('Imports OK')"</verify>
  <done>Prompts updated: sufficiency check removed, synthesis → extraction, question gen doesn't decide when to stop</done>
</task>

<task type="auto">
  <name>Task 2: Revise QuestioningService to match distillation principle</name>
  <files>vector_app/services/questioning_service.py</files>
  <action>
Update the service to be pure distillation:

**1. Remove check_exit_condition method entirely** OR replace with simple skip detection:
```python
def detect_skip_request(self, user_message: str) -> tuple[bool, str]:
    """Detect if user wants to skip questioning.

    Returns:
        Tuple of (should_skip, detected_keyword)
        - should_skip: True if skip keyword detected
        - detected_keyword: The keyword that triggered skip (empty if not)

    NOTE: This does NOT decide sufficiency. Only reports if user said "skip".
    """
    message_lower = user_message.lower().strip()
    for keyword in SKIP_KEYWORDS:
        if keyword in message_lower:
            return (True, keyword)
    return (False, "")
```

**2. Rename synthesize_requirements → extract_facts:**
```python
def extract_facts(
    self,
    chat_history: List[Dict],
    initial_request: str,
    model: AIModel = AIModel.CLAUDE_SONNET_4_5,
) -> Optional[Dict[str, Any]]:
    """Extract facts from the conversation — NO INFERENCE.

    Returns dict with:
    - goals: List of explicitly stated goals
    - explicit_requirements: List of stated requirements
    - ui_mentions: List of UI/UX specifics mentioned
    - unknowns: List of things not answered or unclear

    The main agent uses this to decide next steps.
    """
```

**3. Update imports to use new prompt names:**
- Remove SUFFICIENCY_CHECK_* imports
- Change SYNTHESIS_* → EXTRACTION_*

**4. Update QuestioningResult dataclass:**
- Remove `is_complete` field (service doesn't decide this)
- Remove `reasoning` field (service doesn't explain decisions)
- Keep `should_skip` (boolean flag for skip detection)
- Keep `next_question` for question generation
- Change `synthesized_requirements` → `extracted_facts`

New structure:
```python
@dataclass
class QuestioningResult:
    """Result of a questioning service operation.

    NOTE: This service DISTILLS only. It does not decide sufficiency.
    The main agent receives these facts and decides next steps.
    """
    next_question: Optional[str] = None
    extracted_facts: Optional[Dict[str, Any]] = None
    skip_requested: bool = False
    skip_keyword: str = ""
```

**5. Update __all__ exports:**
- Keep QuestioningResult, QuestioningService, get_questioning_service

**6. Update module docstring:**
- Clarify this is a distillation layer, not a decision-maker
- Document the architectural principle
  </action>
  <verify>python -c "from vector_app.services.questioning_service import get_questioning_service, QuestioningResult; s = get_questioning_service(); print('Service OK')"</verify>
  <done>QuestioningService revised: no sufficiency check, extract_facts instead of synthesize, distillation-only</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from vector_app.prompts.questioning import *"` succeeds
- [ ] `python -c "from vector_app.services.questioning_service import *"` succeeds
- [ ] No SUFFICIENCY_CHECK imports remain in service
- [ ] QuestioningResult has extract_facts not synthesized_requirements
- [ ] EXTRACTION prompts exist, SYNTHESIS prompts removed
- [ ] Module docstrings document distillation-only principle
</verification>

<success_criteria>
- Sufficiency check completely removed from service
- Synthesis → Extraction (facts only, no inference)
- Question generation doesn't decide when to stop
- QuestioningResult reflects new distillation-only output
- Architectural principle documented in docstrings
- All imports and exports work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-questioning-service/01-03-SUMMARY.md`

This completes the Phase 1 revision. The QuestioningService is now a pure distillation layer — it extracts facts and unknowns, the main agent decides everything else.
</output>
