[tools]
node = "24"
python = "3.11"
uv = "latest"

[env]
VIRTUAL_ENV = "{{config_root}}/apps/backend/.venv"

[tasks.fe]
description = "Start frontend dev server"
dir = "{{config_root}}/apps/web"
run = "npm run dev -- --port 5176"

[tasks.be]
description = "Start backend Django server"
dir = "{{config_root}}/apps/backend"
run = "uv run python manage.py runserver 8001"

[tasks.celery]
description = "Start Celery worker"
dir = "{{config_root}}/apps/backend"
run = "uv run celery -A internal_apps worker --loglevel=info"

[tasks.flower]
description = "Start Flower Celery monitor (http://localhost:5555)"
dir = "{{config_root}}/apps/backend"
run = "uv run celery -A internal_apps flower --port=5555"

[tasks.docker]
description = "Start Docker services (Redis, PostgreSQL)"
run = "docker compose up -d"

[tasks.docker-down]
description = "Stop Docker services"
run = "docker compose down"

[tasks.docker-logs]
description = "View Docker service logs"
run = "docker compose logs -f"

[tasks.migrate]
description = "Run Django migrations"
dir = "{{config_root}}/apps/backend"
run = "uv run python manage.py migrate"

[tasks.shell]
description = "Django shell_plus"
dir = "{{config_root}}/apps/backend"
run = "uv run python manage.py shell_plus"

[tasks.test]
description = "Run backend tests"
dir = "{{config_root}}/apps/backend"
run = "uv run pytest -v"

[tasks.setup-fe]
description = "Install frontend dependencies"
dir = "{{config_root}}/apps/web"
run = "mise x -- npm install || true"

[tasks.setup-be]
description = "Install backend dependencies"
dir = "{{config_root}}/apps/backend"
run = "mise x -- uv sync"

[tasks.setup]
description = "Initial setup: install all dependencies"
depends = ["setup-fe", "setup-be"]

[tasks.sync]
description = "Sync backend dependencies with uv"
dir = "{{config_root}}/apps/backend"
run = "uv sync"

[tasks.dev]
description = "Start all development services (docker, frontend, backend, celery, flower)"
depends = ["docker", "fe", "be", "celery", "flower"]
